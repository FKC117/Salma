{% extends 'analytics/base.html' %}
{% load static %}

{% block title %}Dashboard - Data Analysis System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'analytics/css/chat-formatting.css' %}">
<style>
    /* Cursor-style Dashboard Layout */
    .dashboard-container {
        display: grid !important;
        grid-template-columns: 280px 4px 1fr 4px 320px;
        grid-template-rows: 1fr !important;
        height: calc(100vh - 48px) !important;
        gap: 0 !important;
        padding: 0 !important;
        position: fixed !important;
        top: 48px !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 1 !important;
        background-color: var(--cursor-bg-primary) !important;
        width: 100vw !important;
    }

    /* Left Sidebar - Tools Panel */
    .tools-panel {
        background-color: var(--cursor-bg-secondary) !important;
        border-right: 1px solid var(--cursor-border) !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        overflow: hidden !important;
        grid-column: 1 !important;
        grid-row: 1 !important;
    }

    .tools-header {
        background-color: var(--cursor-bg-tertiary);
        border-bottom: 1px solid var(--cursor-border);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .tools-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    /* Main Content Area */
    .dashboard-panel {
        background-color: var(--cursor-bg-primary) !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        overflow: hidden !important;
        grid-column: 3 !important;
        grid-row: 1 !important;
    }

    .dashboard-header {
        background-color: var(--cursor-bg-secondary);
        border-bottom: 1px solid var(--cursor-border);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .dashboard-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
        min-width: 0;
    }
    
    .dashboard-header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .dashboard-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: var(--cursor-bg-primary);
    }

    /* Right Sidebar - Chat Panel */
    .chat-panel {
        background-color: var(--cursor-bg-secondary) !important;
        border-left: 1px solid var(--cursor-border) !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        overflow: hidden !important;
        grid-column: 5 !important;
        grid-row: 1 !important;
    }

    .chat-header {
        background-color: var(--cursor-bg-tertiary);
        border-bottom: 1px solid var(--cursor-border);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .chat-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 16px;
    }

    .chat-input-area {
        flex-shrink: 0;
    }

    /* Cursor-style Resizers */
    .resizer {
        background-color: transparent;
        cursor: col-resize;
        position: relative;
        z-index: 10;
        transition: var(--cursor-transition);
        grid-row: 1;
        height: 100%;
    }

    .resizer:hover {
        background-color: var(--cursor-border-focus);
    }

    .resizer.vertical {
        width: 4px;
    }

    .resizer.vertical:hover {
        width: 6px;
        background-color: var(--cursor-border-focus);
    }

    /* Position resizers between panels */
    .resizer#tools-dashboard-resizer {
        grid-column: 2;
        grid-row: 1;
    }

    .resizer#dashboard-chat-resizer {
        grid-column: 4;
        grid-row: 1;
    }

    /* Cursor-style Tool Items */
    .tool-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: var(--cursor-border-radius);
        color: var(--cursor-text-secondary);
        text-decoration: none;
        transition: var(--cursor-transition);
        font-size: 14px;
        font-weight: 500;
    }

    .tool-item:hover {
        background-color: var(--cursor-bg-tertiary);
        color: var(--cursor-text-primary);
    }

    .tool-item.active {
        background-color: var(--cursor-bg-quaternary);
        color: var(--cursor-text-primary);
    }

    .tool-item i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }

    /* Cursor-style Chat Messages */
    .chat-message {
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
    }

    .message-content {
        background-color: var(--cursor-bg-tertiary);
        border: 1px solid var(--cursor-border);
        border-radius: var(--cursor-border-radius);
        padding: 12px 16px;
        max-width: 85%;
        word-wrap: break-word;
    }

    .message-content.user {
        background-color: var(--cursor-accent-blue);
        color: white;
        margin-left: auto;
    }

    .message-content.assistant {
        background-color: var(--cursor-bg-tertiary);
        color: var(--cursor-text-primary);
    }

    .message-time {
        font-size: 12px;
        color: var(--cursor-text-muted);
        margin-top: 4px;
    }


    /* Cursor-style Search */
    .search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .search-input {
        width: 100%;
        padding: 8px 12px 8px 36px;
        background-color: var(--cursor-bg-tertiary);
        border: 1px solid var(--cursor-border);
        border-radius: var(--cursor-border-radius);
        color: var(--cursor-text-primary);
        font-size: 14px;
    }

    .search-input:focus {
        border-color: var(--cursor-border-focus);
        box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--cursor-text-muted);
        font-size: 14px;
    }

    /* Ensure container-fluid doesn't interfere */
    .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        max-width: none !important;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .dashboard-container {
            grid-template-columns: 240px 4px 1fr 4px 280px !important;
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            grid-template-columns: 1fr !important;
            grid-template-rows: auto 1fr auto !important;
            position: relative !important;
            height: auto !important;
        }
        
        .tools-panel, .chat-panel {
            height: 250px !important;
            grid-column: 1 !important;
        }
        
        .resizer {
            display: none !important;
        }
        
        .dashboard-header {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }
        
        .dashboard-header-left {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        
        .dashboard-header-right {
            justify-content: center;
        }
        
    }

    @media (max-width: 480px) {
        .tools-panel, .chat-panel {
            height: 200px !important;
        }
        
        .dashboard-header {
            padding: 8px 12px;
        }
        
        .dashboard-header-left h6 {
            font-size: 0.875rem;
        }
        
    }

    /* Cursor-style Animations */
    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
        animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn {
        from { transform: translateX(-10px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Dataset Info Display */
    .dataset-info-display {
        background-color: var(--cursor-bg-secondary);
        border-bottom: 1px solid var(--cursor-border);
        padding: 8px 16px;
    }
    
    /* Modal Styles - Force proper z-index and interaction */
    .modal {
        z-index: 9999 !important;
        position: fixed !important;
    }
    
    .modal-backdrop {
        z-index: 9998 !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
    }
    
    .modal-dialog {
        pointer-events: auto !important;
        z-index: 10000 !important;
    }
    
    .modal-content {
        pointer-events: auto !important;
        background-color: var(--cursor-bg-tertiary) !important;
        border: 1px solid var(--cursor-border) !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .modal-header {
        background-color: var(--cursor-bg-quaternary) !important;
        border-bottom: 1px solid var(--cursor-border) !important;
    }
    
    .modal-body {
        background-color: var(--cursor-bg-tertiary) !important;
        color: var(--cursor-text-primary) !important;
    }
    
    .modal-footer {
        background-color: var(--cursor-bg-quaternary) !important;
        border-top: 1px solid var(--cursor-border) !important;
    }
    
    /* Ensure buttons are clickable */
    .modal .btn {
        pointer-events: auto !important;
        opacity: 1 !important;
        cursor: pointer !important;
    }
    
    .modal .form-control {
        pointer-events: auto !important;
        opacity: 1 !important;
    }
    
    /* Dataset Grid Styles */
    .dataset-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .compact-dataset-card {
        background-color: var(--cursor-bg-secondary);
        border: 1px solid var(--cursor-border);
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
        height: fit-content;
        pointer-events: auto !important;
    }
    
    .compact-dataset-card:hover {
        border-color: var(--cursor-accent-blue);
        box-shadow: 0 2px 8px rgba(88, 166, 255, 0.1);
    }
    
    .compact-dataset-card.selected {
        border-color: var(--cursor-accent-blue);
        background-color: rgba(88, 166, 255, 0.1);
    }
    
    .card-header-compact {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .dataset-icon-card {
        width: 1.5rem;
        height: 1.5rem;
        background-color: var(--cursor-bg-tertiary);
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .dataset-icon-card i {
        color: var(--cursor-accent-blue);
        font-size: 0.75rem;
    }
    
    .dataset-info-card {
        flex: 1;
        min-width: 0;
    }
    
    .dataset-name-card {
        margin: 0 0 0.125rem 0;
        color: var(--cursor-text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dataset-description-card {
        margin: 0;
        font-size: 0.75rem;
        line-height: 1.3;
        color: var(--cursor-text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dataset-actions-card {
        flex-shrink: 0;
    }
    
    .dataset-actions-card .btn {
        padding: 0.125rem 0.375rem;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        pointer-events: auto !important;
    }
    
    .card-body-compact {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .dataset-stats-card {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .stat-compact-card {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
    }
    
    .stat-compact-card i {
        color: var(--cursor-accent-blue);
        font-size: 0.75rem;
    }
    
    .stat-value-card {
        color: var(--cursor-text-primary);
        font-weight: 500;
    }
    
    .dataset-meta-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
    }
    
    .status-badge-card {
        font-size: 0.625rem;
        padding: 0.125rem 0.375rem;
    }
    
    .created-date-card {
        font-size: 0.625rem;
    }
    
    /* Analysis Results Container */
    .analysis-results-container {
        margin-top: 2rem;
    }
    
    .analysis-result-container {
        background-color: var(--cursor-bg-secondary);
        border: 1px solid var(--cursor-border);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .analysis-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--cursor-border);
    }
    
    .analysis-title-section {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .analysis-icon {
        width: 3rem;
        height: 3rem;
        background-color: var(--cursor-accent-blue);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .analysis-icon i {
        color: white;
        font-size: 1.25rem;
    }
    
    .analysis-title {
        margin: 0 0 0.5rem 0;
        color: var(--cursor-text-primary);
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .analysis-description {
        margin: 0;
        color: var(--cursor-text-secondary);
        font-size: 0.9rem;
    }
    
    .analysis-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .analysis-content {
        color: var(--cursor-text-primary);
    }
    
    .summary-stats {
        background-color: var(--cursor-bg-tertiary);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
    }
    
    .stat-label {
        font-weight: 500;
        color: var(--cursor-text-secondary);
    }
    
    .stat-value {
        font-weight: 600;
        color: var(--cursor-accent-blue);
    }
    
    .analysis-execution-status {
        background-color: var(--cursor-bg-tertiary);
        border: 1px solid var(--cursor-border);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .execution-progress {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .progress {
        flex: 1;
        height: 0.5rem;
        background-color: var(--cursor-bg-secondary);
    }
    
    .progress-bar {
        background-color: var(--cursor-accent-blue);
    }
    
    .execution-status-text {
        color: var(--cursor-text-primary);
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="dashboard-container">
    <!-- Left Sidebar: Tools Panel -->
    <div class="tools-panel" id="tools-panel">
        <div class="tools-header">
            <h6 class="mb-0 fw-semibold">Tools</h6>
            <button class="btn btn-outline" data-bs-toggle="collapse" data-bs-target="#tools-search">
                <i class="bi bi-search"></i>
            </button>
        </div>
        
        <div class="tools-content">
            <!-- Dataset List Panel -->
            {% include 'analytics/partials/dataset_list.html' %}
            
            <!-- Search Box -->
            <div class="search-box collapse" id="tools-search">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search tools..." 
                       hx-get="/api/tools/search/" 
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#tools-list">
            </div>
            
            <!-- Analysis Tools Section -->
            <div class="mb-3">
                <div class="tool-item" data-bs-toggle="modal" data-bs-target="#analysisToolsModal">
                    <i class="bi bi-tools"></i>
                    <span>Analysis Tools</span>
                    <i class="bi bi-arrow-right ms-auto"></i>
                </div>
                <div class="ms-3 mt-2">
                    <small class="text-muted">Click to open the analysis tools modal with 15+ statistical, visualization, and ML tools.</small>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="dashboard-panel" id="dashboard-panel">
        <div class="dashboard-header">
            <div class="dashboard-header-left">
                <h6 class="mb-0 fw-semibold">Analytical Dashboard</h6>
                <!-- Compact Dataset Switcher -->
                {% include 'analytics/partials/compact_dataset_switcher.html' %}
            </div>
            <div class="dashboard-header-right">
                <button class="btn btn-outline me-2" data-bs-toggle="modal" data-bs-target="#analysisToolsModal">
                    <i class="bi bi-tools"></i>
                    <span class="d-none d-md-inline ms-1">Analysis Tools</span>
                </button>
                <button class="btn btn-outline" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i>
                    <span class="d-none d-md-inline ms-1">Upload</span>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" hx-get="/api/analysis/export/" hx-target="#dashboard-content">
                            <i class="bi bi-download me-2"></i>Export Results
                        </a></li>
                        <li><a class="dropdown-item" href="#" hx-post="/api/analysis/clear/" hx-target="#dashboard-content">
                            <i class="bi bi-trash me-2"></i>Clear Results
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div id="dashboard-content">
                
                <!-- Analysis Results will be loaded here via HTMX -->
                
        <!-- Analysis History Section -->
        <div class="row mb-4">
            <div class="col-12">
                {% include 'analytics/partials/analysis_history.html' %}
            </div>
        </div>
        
        <!-- Analysis Results Container -->
        <div id="analysisResultsContainer" class="analysis-results-container">
            <!-- Analysis results will be displayed here -->
        </div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar: Chat Panel -->
    <div class="chat-panel" id="chat-panel">
        <div class="chat-header">
            <h6 class="mb-0 fw-semibold">AI Assistant</h6>
            <div class="dropdown">
                <button class="btn btn-outline" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" hx-get="/api/chat/clear/" hx-target="#chat-messages">
                        <i class="bi bi-trash me-2"></i>Clear Chat
                    </a></li>
                    <li><a class="dropdown-item" href="#" hx-get="/api/chat/export/" hx-target="#chat-messages">
                        <i class="bi bi-download me-2"></i>Export Chat
                    </a></li>
                </ul>
            </div>
        </div>
        
        <div class="chat-content">
            <div id="chat-messages" class="chat-messages">
                <!-- Welcome Message -->
                <div class="chat-message slide-in">
                    <div class="message-content assistant">
                        <p class="mb-0">Hello! I'm your AI assistant. I can help you interpret analysis results, suggest next steps, and answer questions about your data.</p>
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <form hx-post="/api/chat/messages/" 
                      hx-target="#chat-messages" 
                      hx-swap="beforeend"
                      hx-indicator="#chat-loading">
                    {% csrf_token %}
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control" name="message" placeholder="Ask me anything..." required>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    <div class="form-check form-check-sm mt-2">
                        <input class="form-check-input" type="checkbox" name="include_context" id="include-context" checked>
                        <label class="form-check-label" for="include-context">
                            Include analysis context
                        </label>
                    </div>
                </form>
                
                <!-- Loading Indicator -->
                <div id="chat-loading" class="htmx-indicator">
                    <div class="text-center py-2">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Move modals outside the main container to avoid CSS conflicts -->

<!-- Analysis Tools Modal -->
{% include 'analytics/partials/analysis_tools_modal.html' %}

<!-- Compact Dataset Switcher Modal -->
<div class="modal fade" id="compactDatasetSwitcherModal" tabindex="-1" aria-labelledby="compactDatasetSwitcherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header bg-secondary">
                <h5 class="modal-title" id="compactDatasetSwitcherModalLabel">
                    <i class="bi bi-database"></i> Switch Dataset
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search and Filter -->
                <div class="dataset-search mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-light border-secondary">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="compactDatasetSearch" placeholder="Search datasets...">
                    </div>
                </div>
                
                <!-- Dataset Grid -->
                <div class="dataset-grid" id="compactDatasetGrid">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading datasets...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCompactDatasetSwitch" disabled>
                    <i class="bi bi-check-circle"></i> Switch Dataset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header bg-secondary">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="bi bi-upload"></i> Upload Dataset
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="datasetFile" class="form-label">Select Dataset File</label>
                        <input type="file" class="form-control bg-dark text-light border-secondary" id="datasetFile" name="file" accept=".csv,.xlsx,.xls,.json,.parquet" required>
                        <div class="form-text text-muted">Supported formats: CSV, Excel, JSON, Parquet</div>
                    </div>
                    <div class="mb-3">
                        <label for="datasetName" class="form-label">Dataset Name (Optional)</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="datasetName" name="name" placeholder="Leave empty to use filename">
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadBtn">
                    <i class="bi bi-upload"></i> Upload Dataset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compact Dataset Card Template -->
<template id="compactDatasetCardTemplate">
    <div class="compact-dataset-card" data-dataset-id="">
        <div class="card-header-compact">
            <div class="dataset-icon-card">
                <i class="bi bi-database"></i>
            </div>
            <div class="dataset-info-card">
                <h6 class="dataset-name-card"></h6>
                <p class="dataset-description-card text-muted"></p>
            </div>
            <div class="dataset-actions-card">
                <button class="btn btn-sm btn-outline-primary select-dataset-compact">
                    <i class="bi bi-check-circle"></i>
                </button>
            </div>
        </div>
        <div class="card-body-compact">
            <div class="dataset-stats-card">
                <div class="stat-compact-card">
                    <i class="bi bi-table"></i>
                    <span class="stat-value-card rows"></span>
                </div>
                <div class="stat-compact-card">
                    <i class="bi bi-columns"></i>
                    <span class="stat-value-card columns"></span>
                </div>
                <div class="stat-compact-card">
                    <i class="bi bi-hdd"></i>
                    <span class="stat-value-card size"></span>
                </div>
            </div>
            <div class="dataset-meta-card">
                <span class="badge bg-success status-badge-card"></span>
                <span class="text-muted created-date-card"></span>
            </div>
        </div>
    </div>
</template>

<!-- Panel Resizers will be created by JavaScript -->
{% endblock %}

{% block extra_js %}
<script>
// Cursor-style Panel Resizing
class CursorPanelResizer {
    constructor() {
        this.container = document.querySelector('.dashboard-container');
        this.isResizing = false;
        this.currentResizer = null;
        this.startX = 0;
        this.startColumns = [];
        
        this.init();
    }
    
    init() {
        this.createResizers();
        this.bindEvents();
        this.loadPanelState();
    }
    
    createResizers() {
        // Check if resizers already exist
        if (document.getElementById('tools-dashboard-resizer') && document.getElementById('dashboard-chat-resizer')) {
            return; // Resizers already exist
        }
        
        // Create vertical resizers between panels
        const toolsResizer = this.createResizer('vertical', 'tools-dashboard'); 
        const chatResizer = this.createResizer('vertical', 'dashboard-chat');   

        // Insert resizers into DOM at correct positions
        this.container.insertBefore(toolsResizer, this.container.children[1]);  
        this.container.insertBefore(chatResizer, this.container.children[3]);   
    }
    
    createResizer(direction, id) {
        const resizer = document.createElement('div');
        resizer.className = `resizer ${direction}`;
        resizer.id = id;
        return resizer;
    }
    
    bindEvents() {
        // Use event delegation for dynamically created resizers
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('resizer')) {
                e.preventDefault();
                this.startResize(e);
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (this.isResizing) {
                e.preventDefault();
                this.resize(e);
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (this.isResizing) {
                e.preventDefault();
                this.stopResize();
            }
        });
    }
    
    startResize(e) {
        console.log('Starting resize with resizer:', e.target.id);
        this.isResizing = true;
        this.currentResizer = e.target;
        this.startX = e.clientX;
        this.startColumns = this.getCurrentColumns();

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';

        // Add visual feedback
        this.currentResizer.style.backgroundColor = 'var(--cursor-border-focus)';
    }
    
    resize(e) {
        const containerRect = this.container.getBoundingClientRect();
        const deltaX = e.clientX - this.startX;
        const containerWidth = containerRect.width;
        
        // Add sensitivity multiplier for more responsive resizing
        const sensitivity = 1.5;
        const adjustedDeltaX = deltaX * sensitivity;

        console.log('Resizing:', this.currentResizer.id, 'deltaX:', deltaX, 'adjustedDeltaX:', adjustedDeltaX, 'containerWidth:', containerWidth);

        if (this.currentResizer.id === 'tools-dashboard') {
            // Resize tools panel (200px to 600px range) - much larger range
            const newToolsWidth = Math.max(200, Math.min(600, 280 + adjustedDeltaX));
            const remainingWidth = containerWidth - newToolsWidth - 4 - 320 - 4; // 4px for resizers, 320px for chat

            const newGridTemplate = `${newToolsWidth}px 4px ${remainingWidth}px 4px 320px`;
            console.log('New grid template:', newGridTemplate);
            this.container.style.setProperty('grid-template-columns', newGridTemplate, 'important');
        } else if (this.currentResizer.id === 'dashboard-chat') {
            // Resize chat panel (200px to 600px range) - much larger range
            const newChatWidth = Math.max(200, Math.min(600, 320 - adjustedDeltaX));
            const remainingWidth = containerWidth - 280 - 4 - newChatWidth - 4; // 280px for tools, 4px for resizers

            const newGridTemplate = `280px 4px ${remainingWidth}px 4px ${newChatWidth}px`;
            console.log('New grid template:', newGridTemplate);
            this.container.style.setProperty('grid-template-columns', newGridTemplate, 'important');
        }
    }
    
    stopResize() {
        this.isResizing = false;
        this.currentResizer.style.backgroundColor = '';
        this.currentResizer = null;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        this.savePanelState();
    }
    
    getCurrentColumns() {
        const computedStyle = window.getComputedStyle(this.container);
        return computedStyle.gridTemplateColumns.split(' ');
    }
    
    savePanelState() {
        const state = {
            gridTemplateColumns: this.container.style.gridTemplateColumns,
            timestamp: Date.now()
        };
        localStorage.setItem('cursorPanelState', JSON.stringify(state));
    }
    
    loadPanelState() {
        const saved = localStorage.getItem('cursorPanelState');
        if (saved) {
            const state = JSON.parse(saved);
            if (state.gridTemplateColumns) {
                this.container.style.setProperty('grid-template-columns', state.gridTemplateColumns, 'important');
            }
        }
    }
}

// Cursor-style Tool Interactions
class CursorToolManager {
    constructor() {
        this.init();
    }
    
    init() {
        this.bindToolEvents();
        this.bindSearchEvents();
    }
    
    bindToolEvents() {
        // Tool item hover effects
        document.addEventListener('mouseover', (e) => {
            if (e.target.closest('.tool-item')) {
                e.target.closest('.tool-item').classList.add('hover');
            }
        });
        
        document.addEventListener('mouseout', (e) => {
            if (e.target.closest('.tool-item')) {
                e.target.closest('.tool-item').classList.remove('hover');
            }
        });
        
        // Tool item click effects
        document.addEventListener('click', (e) => {
            if (e.target.closest('.tool-item') && e.target.closest('.tool-item').hasAttribute('href')) {
                e.preventDefault();
                this.handleToolClick(e.target.closest('.tool-item'));
            }
        });
    }
    
    bindSearchEvents() {
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.filterTools(e.target.value);
            });
        }
    }
    
    handleToolClick(toolItem) {
        // Add active state
        document.querySelectorAll('.tool-item').forEach(item => item.classList.remove('active'));
        toolItem.classList.add('active');
        
        // Add click animation
        toolItem.style.transform = 'scale(0.95)';
        setTimeout(() => {
            toolItem.style.transform = '';
        }, 150);
    }
    
    filterTools(query) {
        const toolItems = document.querySelectorAll('.tool-item');
        const searchQuery = query.toLowerCase();
        
        toolItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchQuery)) {
                item.style.display = 'flex';
                item.classList.add('slide-in');
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// Cursor-style Chat Manager
class CursorChatManager {
    constructor() {
        this.init();
    }
    
    init() {
        this.bindChatEvents();
    }
    
    bindChatEvents() {
        const chatForm = document.querySelector('form[hx-post="/api/chat/messages/"]');
        if (chatForm) {
            chatForm.addEventListener('submit', (e) => {
                this.handleMessageSubmit(e);
            });
        }
    }
    
    handleMessageSubmit(e) {
        const input = e.target.querySelector('input[name="message"]');
        const message = input.value.trim();
        
        if (message) {
            // Add user message immediately
            this.addMessage(message, 'user');
            input.value = '';
        }
    }
    
    addMessage(content, type) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type === 'user' ? 'slide-in' : 'fade-in'}`;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
            <div class="message-content ${type}">
                <p class="mb-0">${content}</p>
            </div>
            <div class="message-time">${timeString}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new CursorPanelResizer();
    new CursorToolManager();
    new CursorChatManager();
    
    // Add smooth animations
    document.body.style.opacity = '0';
    document.body.style.transition = 'opacity 0.3s ease-in-out';
    
    setTimeout(() => {
        document.body.style.opacity = '1';
    }, 100);
    
    // Update dashboard with dataset info
    window.updateDashboardDatasetInfo = function(response) {
        const datasetInfoDisplay = document.getElementById('dataset-info-display');
        const datasetName = document.getElementById('current-dataset-name');
        const datasetStats = document.getElementById('current-dataset-stats');
        
        if (response && response.dataset_id) {
            // Show dataset info
            datasetInfoDisplay.style.display = 'block';
            
            // Use dataset info if available, otherwise fallback to message parsing
            if (response.dataset_info) {
                datasetName.textContent = response.dataset_info.name;
                datasetStats.textContent = `${response.dataset_info.row_count || 0} rows × ${response.dataset_info.column_count || 0} columns`;
            } else {
                datasetName.textContent = response.message.replace('Dataset "', '').replace('" uploaded successfully', '');
                datasetStats.textContent = `${response.columns.length} columns`;
            }
            
        }
    };
    
    // Clear current dataset
    window.clearCurrentDataset = function() {
        const datasetInfoDisplay = document.getElementById('dataset-info-display');
        datasetInfoDisplay.style.display = 'none';
        
    };
    
    // Smart Content Formatter
    class SmartContentFormatter {
        constructor() {
            this.contentTypes = {
                TABLE: 'table',
                CHART: 'chart',
                CODE: 'code',
                JSON: 'json',
                LIST: 'list',
                QUOTE: 'quote',
                TEXT: 'text'
            };
            
            this.patterns = {
                table: [
                    /^\s*\|[^|]+\|[^|]+\|[^|]+\|[^|]+\|\s*$/m,  // At least 3 columns
                    /^\s*\|[^|]+\|[^|]+\|[^|]+\|\s*$/m,  // At least 2 columns
                    /^\s*\|[^|]+\|[^|]+\|\s*$/m  // At least 1 column
                ],
                chart: [
                    /chart|graph|plot|visualization/i,
                    /bar chart|line chart|pie chart|scatter plot/i,
                    /histogram|heatmap|correlation matrix/i
                ],
                code: [
                    /```[\s\S]*?```/g,
                    /`[^`]+`/g,
                    /def\s+\w+|function\s+\w+|class\s+\w+/i
                ],
                json: [
                    /^\s*[\{\[].*[\}\]]\s*$/s,
                    /"[\w\s]+"\s*:\s*["\d\w\s,{}[\]]+/
                ],
                list: [
                    /^\s*[-*+]\s+.+$/m,
                    /^\s*\d+\.\s+.+$/m,
                    /^\s*•\s+.+$/m
                ],
                quote: [
                    /^>\s+.+$/m,
                    /^"[\s\S]*"$/m,
                    /^'[\s\S]*'$/m
                ]
            };
        }
        
        detectContentType(text) {
            if (!text || typeof text !== 'string') {
                return this.contentTypes.TEXT;
            }
            
            console.log('=== DETECTING CONTENT TYPE ===');
            console.log('Input text:', text);
            console.log('Text length:', text.length);
            
            // Check if it contains metadata (not a real table)
            if (text.includes('tokens') || text.includes('$0.') || text.includes('04:')) {
                console.log('❌ Contains metadata, not a real table');
                return this.contentTypes.TEXT;
            }
            
            // Look for markdown table pattern: | col1 | col2 | col3 |
            const lines = text.split('\n');
            console.log('All lines:', lines);
            
            const tableLines = lines.filter(line => {
                const trimmed = line.trim();
                const hasPipe = trimmed.includes('|');
                const notMetadata = !trimmed.includes('tokens') && !trimmed.includes('$0.') && !trimmed.includes('04:');
                const longEnough = trimmed.length > 5;
                const result = hasPipe && notMetadata && longEnough;
                console.log(`Line: "${trimmed}" - hasPipe: ${hasPipe}, notMetadata: ${notMetadata}, longEnough: ${longEnough}, result: ${result}`);
                return result;
            });
            
            console.log('✅ Found table lines:', tableLines);
            
            if (tableLines.length < 2) {
                console.log('❌ Not enough table lines found (need at least 2)');
                return this.contentTypes.TEXT;
            }
            
            // Check if it looks like a proper table (has multiple columns)
            const hasMultipleColumns = tableLines.some(line => {
                const cells = line.split('|').filter(cell => cell.trim().length > 0);
                console.log(`Line "${line}" has ${cells.length} cells:`, cells);
                return cells.length >= 2;
            });
            
            if (!hasMultipleColumns) {
                console.log('❌ No multiple columns found');
                return this.contentTypes.TEXT;
            }
            
            console.log('✅ TABLE DETECTED!');
            return this.contentTypes.TABLE;
            
            if (this.patterns.chart.some(pattern => pattern.test(text))) {
                return this.contentTypes.CHART;
            }
            
            if (this.patterns.code.some(pattern => pattern.test(text))) {
                return this.contentTypes.CODE;
            }
            
            if (this.patterns.json.some(pattern => pattern.test(text))) {
                return this.contentTypes.JSON;
            }
            
            if (this.patterns.list.some(pattern => pattern.test(text))) {
                return this.contentTypes.LIST;
            }
            
            if (this.patterns.quote.some(pattern => pattern.test(text))) {
                return this.contentTypes.QUOTE;
            }
            
            return this.contentTypes.TEXT;
        }
        
        formatContent(text, contentType = null) {
            if (!contentType) {
                contentType = this.detectContentType(text);
            }
            
            switch (contentType) {
                case this.contentTypes.TABLE:
                    return this.formatTable(text);
                case this.contentTypes.CHART:
                    return this.formatChart(text);
                case this.contentTypes.CODE:
                    return this.formatCode(text);
                case this.contentTypes.JSON:
                    return this.formatJSON(text);
                case this.contentTypes.LIST:
                    return this.formatList(text);
                case this.contentTypes.QUOTE:
                    return this.formatQuote(text);
                default:
                    return this.formatText(text);
            }
        }
        
        formatTable(text) {
            console.log('formatTable called with text:', text);
            const lines = text.trim().split('\n');
            const tableRows = lines.filter(line => line.includes('|'));
            
            console.log('Found table rows:', tableRows);
            
            if (tableRows.length < 2) {
                console.log('Not enough table rows, falling back to text');
                return this.formatText(text);
            }
            
            const tableData = this.extractTableData(tableRows);
            
            if (tableData.headers.length === 0 || tableData.rows.length === 0) {
                console.log('No valid table data found, falling back to text formatting');
                return this.formatText(text);
            }
            
            let html = '<div class="table-container">';
            html += '<div class="table-header">';
            html += '<div class="table-title">';
            html += '<h6><i class="bi bi-table"></i> Data Table</h6>';
            html += `<span class="table-meta">${tableData.rows.length} rows × ${tableData.headers.length} columns</span>`;
            html += '</div>';
            html += '<div class="table-actions">';
            html += '<div class="btn-group" role="group">';
            html += '<button class="btn btn-sm btn-outline-secondary" onclick="exportTable(this, \'csv\')">';
            html += '<i class="bi bi-file-earmark-spreadsheet"></i> CSV</button>';
            html += '<button class="btn btn-sm btn-outline-secondary" onclick="exportTable(this, \'json\')">';
            html += '<i class="bi bi-file-earmark-code"></i> JSON</button>';
            html += '<button class="btn btn-sm btn-outline-secondary" onclick="fullscreenTable(this)">';
            html += '<i class="bi bi-arrows-fullscreen"></i> Fullscreen</button>';
            html += '</div></div></div>';
            
            html += '<div class="table-content">';
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover table-sm">';
            html += '<thead class="table-dark">';
            html += '<tr>';
            tableData.headers.forEach(header => {
                html += `<th scope="col">${this.escapeHtml(header)}</th>`;
            });
            html += '</tr></thead>';
            html += '<tbody>';
            
            tableData.rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${this.escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '</div></div>';
            html += '<div class="table-footer">';
            html += '<div class="pagination-info">';
            html += `Showing 1 to ${Math.min(10, tableData.rows.length)} of ${tableData.rows.length} entries`;
            html += '</div></div></div>';
            
            return html;
        }
        
        extractTableData(tableRows) {
            console.log('Extracting table data from rows:', tableRows);
            
            // Filter out separator rows and metadata rows
            const dataRows = tableRows.filter(row => {
                const trimmed = row.trim();
                return trimmed.includes('|') && 
                       !trimmed.includes('tokens') && 
                       !trimmed.includes('$0.') && 
                       !trimmed.includes('04:') &&
                       !trimmed.match(/^:?-+:?$/) &&  // Not separator rows like | :--- | :--- |
                       trimmed.length > 5; // Not just a single pipe
            });
            
            console.log('Filtered data rows:', dataRows);
            
            if (dataRows.length === 0) {
                console.log('No valid data rows found');
                return { headers: [], rows: [] };
            }
            
            // Extract headers from first row
            const headers = dataRows[0].split('|')
                .map(cell => cell.trim())
                .filter(cell => cell && cell.length > 0);
            
            console.log('Raw headers from first row:', dataRows[0].split('|'));
            console.log('Processed headers:', headers);
            
            const rows = [];
            
            // Extract data rows (skip first row which is headers)
            for (let i = 1; i < dataRows.length; i++) {
                const cells = dataRows[i].split('|')
                    .map(cell => cell.trim())
                    .filter(cell => cell && cell.length > 0);
                
                console.log(`Row ${i} cells:`, cells);
                
                if (cells.length >= 2) { // At least 2 columns
                    rows.push(cells);
                }
            }
            
            console.log('Final extracted headers:', headers);
            console.log('Final extracted rows:', rows);
            
            return { headers, rows };
        }
        
        formatChart(text) {
            const chartType = this.detectChartType(text);
            const chartId = 'chart_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            return `
                <div class="chart-container">
                    <div class="chart-header">
                        <h6><i class="bi bi-bar-chart"></i> ${chartType}</h6>
                        <div class="chart-actions">
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportChart('${chartId}')">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="fullscreenChart('${chartId}')">
                                <i class="bi bi-arrows-fullscreen"></i> Fullscreen
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="${chartId}" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-description">
                        <p class="text-muted">${this.extractChartDescription(text)}</p>
                    </div>
                </div>
            `;
        }
        
        formatCode(text) {
            let html = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || 'text';
                return `<pre class="code-block"><code class="language-${language}">${this.escapeHtml(code.trim())}</code></pre>`;
            });
            
            html = html.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            return html;
        }
        
        formatJSON(text) {
            try {
                const jsonObj = JSON.parse(text);
                const formatted = JSON.stringify(jsonObj, null, 2);
                return `<pre class="json-block"><code>${this.escapeHtml(formatted)}</code></pre>`;
            } catch (e) {
                return this.formatCode(text);
            }
        }
        
        formatList(text) {
            const lines = text.split('\n');
            let html = '';
            let inList = false;
            let listType = 'ul';
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                if (trimmed.match(/^\d+\.\s+/)) {
                    if (!inList || listType !== 'ol') {
                        if (inList) html += `</${listType}>`;
                        html += '<ol class="list-group list-group-flush">';
                        inList = true;
                        listType = 'ol';
                    }
                    const content = trimmed.replace(/^\d+\.\s+/, '');
                    html += `<li class="list-group-item">${this.escapeHtml(content)}</li>`;
                } else if (trimmed.match(/^[-*+•]\s+/)) {
                    if (!inList || listType !== 'ul') {
                        if (inList) html += `</${listType}>`;
                        html += '<ul class="list-group list-group-flush">';
                        inList = true;
                        listType = 'ul';
                    }
                    const content = trimmed.replace(/^[-*+•]\s+/, '');
                    html += `<li class="list-group-item">${this.escapeHtml(content)}</li>`;
                } else if (trimmed === '') {
                    if (inList) {
                        html += '<li class="list-group-item">&nbsp;</li>';
                    }
                } else {
                    if (inList) {
                        html += `</${listType}>`;
                        inList = false;
                    }
                    html += `<p>${this.escapeHtml(trimmed)}</p>`;
                }
            });
            
            if (inList) {
                html += `</${listType}>`;
            }
            
            return html;
        }
        
        formatQuote(text) {
            const lines = text.split('\n');
            let html = '<blockquote class="blockquote">';
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('>')) {
                    const content = trimmed.substring(1).trim();
                    html += `<p class="mb-0">${this.escapeHtml(content)}</p>`;
                } else if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    const content = trimmed.substring(1, trimmed.length - 1);
                    html += `<p class="mb-0">${this.escapeHtml(content)}</p>`;
                } else {
                    html += `<p class="mb-0">${this.escapeHtml(trimmed)}</p>`;
                }
            });
            
            html += '</blockquote>';
            return html;
        }
        
        formatText(text) {
            let html = text;
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }
        
        detectChartType(text) {
            const lowerText = text.toLowerCase();
            
            if (lowerText.includes('bar chart') || lowerText.includes('bar graph')) {
                return 'Bar Chart';
            } else if (lowerText.includes('line chart') || lowerText.includes('line graph')) {
                return 'Line Chart';
            } else if (lowerText.includes('pie chart')) {
                return 'Pie Chart';
            } else if (lowerText.includes('scatter plot')) {
                return 'Scatter Plot';
            } else if (lowerText.includes('histogram')) {
                return 'Histogram';
            } else if (lowerText.includes('heatmap')) {
                return 'Heatmap';
            } else if (lowerText.includes('correlation')) {
                return 'Correlation Matrix';
            } else {
                return 'Chart';
            }
        }
        
        extractChartDescription(text) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 10);
            return sentences[0] ? sentences[0].trim() : 'Data visualization';
        }
        
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        processMessage(messageElement) {
            console.log('=== PROCESSING MESSAGE ===');
            console.log('Processing message element:', messageElement);
            
            const content = messageElement.querySelector('.message-content');
            if (!content) {
                console.log('❌ No message-content found in message element');
                return;
            }
            
            // Check if content is already formatted (contains HTML tags)
            const innerHTML = content.innerHTML;
            if (innerHTML.includes('<div class="table-container">') || 
                innerHTML.includes('<pre>') || 
                innerHTML.includes('<code>') ||
                innerHTML.includes('<strong>') ||
                innerHTML.includes('<em>')) {
                console.log('✅ Content already formatted, skipping processing');
                return;
            }
            
            const text = content.textContent || content.innerText;
            console.log('📝 Message text:', text);
            console.log('📏 Text length:', text.length);
            
            const contentType = this.detectContentType(text);
            console.log('🎯 Detected content type:', contentType);
            
            const formatted = this.formatContent(text, contentType);
            console.log('✅ Final formatted content:', formatted);
            
            content.innerHTML = formatted;
            messageElement.classList.add(`content-${contentType}`);
            
            if (contentType === this.contentTypes.CHART) {
                this.initializeCharts(messageElement);
            }
            
            console.log('=== MESSAGE PROCESSING COMPLETE ===');
        }
        
        initializeCharts(messageElement) {
            const canvases = messageElement.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#58a6ff';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Chart will be rendered here', canvas.width / 2, canvas.height / 2);
            });
        }
    }
    
    // Initialize formatter
    const contentFormatter = new SmartContentFormatter();
    
    // Format existing messages
    const messages = document.querySelectorAll('.chat-message');
    console.log('Found existing messages:', messages.length);
    messages.forEach(message => {
        contentFormatter.processMessage(message);
    });
    
    // Watch for new messages
    const observer = new MutationObserver((mutations) => {
        console.log('Mutation detected:', mutations);
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('chat-message')) {
                    console.log('New chat message detected:', node);
                    contentFormatter.processMessage(node);
                }
            });
        });
    });
    
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        console.log('Setting up mutation observer on chat-messages');
        observer.observe(chatMessages, { childList: true });
    } else {
        console.log('chat-messages element not found');
    }
    
    // Export functions
    window.exportTable = function(button, format) {
        console.log('Exporting table as', format);
        const tableContainer = button.closest('.table-container');
        const table = tableContainer.querySelector('table');
        
        if (!table) {
            console.error('Table not found');
            return;
        }
        
        const data = [];
        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
            if (cells.length === headers.length) {
                data.push(cells);
            }
        });
        
        if (format === 'csv') {
            const csvContent = [
                headers.join(','),
                ...data.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `table_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        } else if (format === 'json') {
            const jsonData = data.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index];
                });
                return obj;
            });
            
            const jsonContent = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `table_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    };
    
    window.fullscreenTable = function(button) {
        console.log('Opening table in fullscreen');
        const tableContainer = button.closest('.table-container');
        const table = tableContainer.querySelector('table');
        
        if (!table) {
            console.error('Table not found');
            return;
        }
        
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-table"></i> Table View - Fullscreen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            ${table.outerHTML}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Clean up when modal is hidden
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    };
    
    window.exportChart = function(chartId) {
        console.log('Exporting chart', chartId);
        const canvas = document.getElementById(chartId);
        if (canvas) {
            const link = document.createElement('a');
            link.download = `chart_${chartId}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    };
    
    window.fullscreenChart = function(chartId) {
        console.log('Opening chart in fullscreen', chartId);
        const chartContainer = document.getElementById(chartId).closest('.chart-container');
        
        if (!chartContainer) {
            console.error('Chart container not found');
            return;
        }
        
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-bar-chart"></i> Chart View - Fullscreen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${chartContainer.outerHTML}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Clean up when modal is hidden
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
    };
});

// AI Interpretation Function
function interpretAnalysisResult(analysisId) {
    console.log('🔍 Starting AI interpretation for analysis:', analysisId);
    
    // Find the analysis result container
    const analysisContainer = document.querySelector(`[data-analysis-id="${analysisId}"]`);
    if (!analysisContainer) {
        console.error('Analysis container not found:', analysisId);
        return;
    }
    
    // Extract analysis data from the container
    const analysisData = extractAnalysisData(analysisContainer);
    const analysisType = analysisContainer.classList.contains('table-analysis-result') ? 'table' : 
                        analysisContainer.classList.contains('chart-analysis-result') ? 'chart' : 'text';
    
    console.log('📊 Analysis data extracted:', analysisData);
    console.log('📈 Analysis type:', analysisType);
    
    // Show loading state
    showInterpretationLoading(analysisId);
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken') || 
                     '{{ csrf_token }}';
    
    // Make API request
    fetch('/api/ai/interpret-analysis/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            analysis_data: analysisData,
            analysis_type: analysisType,
            context: {
                analysis_id: analysisId,
                timestamp: new Date().toISOString()
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('🤖 AI interpretation response:', data);
        
        if (data.success) {
            showInterpretationResult(analysisId, data.interpretation, data.confidence);
        } else {
            showInterpretationError(analysisId, data.error || 'Failed to generate interpretation');
        }
    })
    .catch(error => {
        console.error('❌ Error getting AI interpretation:', error);
        showInterpretationError(analysisId, 'Network error occurred');
    });
}

function extractAnalysisData(container) {
    const title = container.querySelector('.analysis-title')?.textContent || 'Untitled Analysis';
    const description = container.querySelector('.analysis-description')?.textContent || '';
    
    // Extract table data if it's a table analysis
    let content = '';
    const table = container.querySelector('table');
    if (table) {
        const rows = Array.from(table.querySelectorAll('tr')).map(row => 
            Array.from(row.querySelectorAll('th, td')).map(cell => cell.textContent.trim())
        );
        content = `Table Data:\n${rows.map(row => row.join('\t')).join('\n')}`;
    } else {
        // Extract text content
        const textElements = container.querySelectorAll('p, div, span');
        content = Array.from(textElements).map(el => el.textContent.trim()).join('\n');
    }
    
    return {
        title: title,
        description: description,
        content: content,
        timestamp: new Date().toISOString()
    };
}

function showInterpretationLoading(analysisId) {
    const button = document.querySelector(`[onclick="interpretAnalysisResult('${analysisId}')"]`);
    if (button) {
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
        button.disabled = true;
    }
}

function showInterpretationResult(analysisId, interpretation, confidence) {
    // Create interpretation modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-robot"></i> AI Interpretation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="interpretation-content">
                        <div class="confidence-badge mb-3">
                            <span class="badge bg-${confidence > 0.7 ? 'success' : confidence > 0.4 ? 'warning' : 'secondary'}">
                                Confidence: ${Math.round(confidence * 100)}%
                            </span>
                        </div>
                        <div class="interpretation-text">
                            ${interpretation.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyInterpretation('${analysisId}')">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up when modal is hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
    
    // Reset button
    resetInterpretationButton(analysisId);
}

function showInterpretationError(analysisId, error) {
    // Create error modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Interpretation Error
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sorry, we couldn't generate an AI interpretation at this time.</p>
                    <p class="text-muted small">Error: ${error}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up when modal is hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
    
    // Reset button
    resetInterpretationButton(analysisId);
}

function resetInterpretationButton(analysisId) {
    const button = document.querySelector(`[onclick="interpretAnalysisResult('${analysisId}')"]`);
    if (button) {
        button.innerHTML = '<i class="bi bi-robot"></i> Interpret Data by AI';
        button.disabled = false;
    }
}

function copyInterpretation(analysisId) {
    const interpretationText = document.querySelector('.interpretation-text')?.textContent;
    if (interpretationText) {
        navigator.clipboard.writeText(interpretationText).then(() => {
            // Show success message
            const button = document.querySelector('[onclick="copyInterpretation(\'' + analysisId + '\')"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i> Copied!';
            button.classList.add('btn-success');
            button.classList.remove('btn-primary');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 2000);
        });
    }
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- Dataset Switcher Modal -->
{% include 'analytics/partials/dataset_switcher.html' %}

{% endblock %}